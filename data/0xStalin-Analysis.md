# Analysis of the PoolTogether Contest

# Introduction
- The PoolTogether protocol proposition is to gamify the yields earned by depositing assets into vaults. It is an interesting proposition to allow users that are attracted to all-or-nothing types of games because the PoolTogether vaults allow vault depositors to play at random the possibility to win everyone's yields.
- The protocol aims to make the vaults creations fully autonomous and in a permissionless way, this will allow anybody to create vaults that offer the gamification feature that the PoolTogether protocol is building.

## Analysis of the Codebase
- The codebase of this audit included 4 components of the PoolTogether protocol, the Vault, the PrizePool, the TwabController & the Claimer.
- The 4 components are highly interconnected and dependent on each other.
- The Vault can be thought of as the core component because it interacts with all the others.
  - It is in charge of updating the PrizePool accounting and sending and reading data from the TwabController where all the user's balances are tracked.
  - The Claimer is a more optional component because it is up to the Vault's owner to set a claimer using a deployed Claimer contract or not.

![Relationship Diagram](https://res.cloudinary.com/djt3zbrr3/image/upload/v1689360530/relationship_diagram_ivtfu4.png)

- There is a Vault Factory that is in charge of deploying new Vaults.
  - The deployment of new vaults is fully decentralized, it is not required to ask permission from the protocol to deploy a new Vault, or belong to a whitelist or a restriction of any type, it is fully autonomous and decentralized.

- The YieldVault is not exactly a contract coded by the Protocol team, but it is expected to be an ERC4626-compliant contract.
  - Even though there is not much documentation about the YieldVault, I consider it to be a key component of the protocol because all the user's assets will end up being deposited into the YieldVaults.

- I think that this protocol uniqueness feature is how they've accomplished generating on-chain randomness to match the pseudo-randomness values with past values that have been generated by the user's & vault's balances during a specific period of time.
  - Using past values makes it near to impossible to try to compute & force a specific account to be the winner. The reason is that even though the pseudorandom value can be computed before the tx is actually executed, the past values can't be modified and forced to match the pseudorandom value.
    - The Math & Logic involved in this process is quite complex, it is really an artwork.

- Also, the proposition to gamify the yields and allow users to "gamble" their yields in exchange for potentially earning the yields of all the other depositors, is quite interesting because most of the crypto users are investors of high-risk profiles, which I'm pretty sure more than 1 will be interested in this offer.

## Architecture Feedback, Centralization & Systemic Risks
- The protocol is aiming to achieve a fully autonomous and decentralized architecture, but with decentralization comes risks.

- The Asset Flows when depositing and withdrawing to/from the PoolTogether vaults are similar to the process explained in the below diagrams.
  - As we can see, **all the user assets are really deposited in the YieldVaults**, which is why ensuring that the YieldVaults are real and safe vaults is a critical task that the protocol should take care of.

![Deposit Assets Flow](https://res.cloudinary.com/djt3zbrr3/image/upload/v1689359894/deposit_asset_flow.png)

![Withdraw Assets Flow](https://res.cloudinary.com/djt3zbrr3/image/upload/v1689360088/withdraw_assets_flow_sbestw.png)

- The decentralization part is about allowing anybody to create new vaults by using the VaultFactory that is created by the Protocol.
  - Problems can arise if the protocol doesn't enforce the newly created vaults to use the expected contracts for the accounting and holding of the user's assets
    - Malicious users could abuse and deploy fake contracts and set them as the PrizePool, TwabController, and also create fake YieldVaults. This is a critical risk for users' safeness because all the vaults created by the VaultFactory should indicate to the users that these vaults are safe to interact with.
  - That is a critical problem that arises with decentralization, because the creation of the vaults is decentralized, but the ownership of each vault isn't, there is a vault owner who could abuse its power if the contracts don't limitate it.
    - Limitate the vault owner's power is a task of the protocol because the protocol is the one who is allowing anybody to create new vaults using their VaultFactory.
  
- About the Liquidity Distribution fully relies on some advanced math formulas, which basically compute the number of liquidity to be disbursed across the different draws and in each draw computes how much liquidity to distribute among the different tiers.
  - Tiers are flexible, meaning, they can grow or shrink if required.

![Liquidity Distribution](https://res.cloudinary.com/djt3zbrr3/image/upload/v1689360403/liquidity_distribution_en7oxo.png)

![Draw's Liquidity Distribution](https://res.cloudinary.com/djt3zbrr3/image/upload/v1689360483/draw_liquidity_distribution_oo0hgg.png)


- The winners are determined based on pseudorandom-generated values and matching values that have been generated in the past between a specific period of time
  - To achieve this the protocol does some computation between the PrizePool and TwabController contracts.
![determing the winner](https://res.cloudinary.com/djt3zbrr3/image/upload/v1689360322/determing_the_winner_k1jy6m.png)


- The Claimer is only in charge to claim the prizes of the winners (all the prizes are sent to the corresponding winner), and the Claimer earns a fee in exchange for claiming the prizes on behalf of the winners.

## Recommendations
- Always have in mind the fact that if something goes wrong in a vault that was deployed using the VaultFactory, most users will blame the protocol, not the vault owner.
  - In a normal user's mind, the protocol is responsible to ensure that each individual vault is safe and sound.
    - That being said, even though the creation of vaults will be fully decentralized, make sure that the contracts limitate the vault's owners to the minimum privileges that they require to manage the vault.
    - Also, make sure that the contracts enforce the vaults to use the right and expected contracts. Most of the time allowing users to set arbitrary addresses for contracts that interact with the protocol opens up some attack vectors.
      - Always try to mitigate the number of open doors that could be exploited or abused by the vault owners.

# Time Spent on the Audit
- I spent 6 days on this audit, each day I put in around 5-8 hours of work. In total would be around 40 hours.
- 3 days were to analyze and fully understand the codebase.
- 2 days were dedicated only to bug hunting, I didn't follow the recognition pattern, I was mostly focused on identifying critical issues caused by incorrect assumptions and bugs in the code.
- The last day was dedicated to filling out the reports and writing this analysis as well as creating the diagrams.

### Time spent:
40 hours